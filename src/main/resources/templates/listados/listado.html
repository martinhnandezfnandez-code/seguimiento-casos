<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Listado de Casos</title>

    <link rel="icon" href="/logotipo.png">
    <link rel="stylesheet" th:href="@{/css/listado.css}">
</head>

<body>

<div class="container">

    <!-- HEADER -->
    <div class="header">
        <h1> <img src="/images/virgen-del-carmen_512.webp" width="90px" alt="Colegio El Carmen - Carmelitas Descalzos" class="logo"> Listado de Casos</h1>
        <div class="header-buttons">
            <a href="/alumnado/nuevo" class="btn">‚ûï Nuevo Caso</a>
            <a href="/" class="btn btn-secondary">üè† Men√∫</a>
        </div>
        <div class="buscador">
            <label for="buscarCodigo">Buscar por c√≥digo de alumno:</label>
            <input type="text"
                   id="buscarCodigo"
                   placeholder="Ej: ALU-001"
                   onkeyup="filtrarPorCodigo()">
            <button onclick="limpiarFiltro()" class="btn-clear">‚úñ Limpiar</button>
            <span id="resultadosCount"></span>
        </div>
    </div>
    </div>

    <!-- TABLA -->
    <div class="table-wrapper">
        <div class="table-container">
            <table>

                <thead>
                <tr>
                    <th class="id-col">ID</th>
                    <th>ID Caso</th>
                    <th>ID Doc</th>
                    <th>Paso 1: Anexo I</th>
                    <th>Paso 2: Constituci√≥n del EA</th>
                    <th>Paso 2: Acta con medidas inmediatas</th>
                    <th>Paso 2: Informar a familia</th>
                    <th>Paso 2: Informar a Inspecci√≥n</th>
                    <th>Paso 2: Informar a la CPAyC</th>
                    <th>Paso 2: Cronograma Anexo II</th>
                    <th>Paso 2: Antiguo Anexo I</th>
                    <th>Paso 3: Acta</th>
                    <th>Paso 4: Anexo III</th>
                    <th>Paso 5: Anexo IV</th>
                    <th>Paso 5: Anexo V</th>
                    <th>Paso 6: Anexo VI</th>
                    <th>Paso 7: Anexo VII</th>
                    <th>Paso 8: Anexo VIII</th>
                    <th>Paso 9: Director/a informa a las Familias del plan</th>
                    <th>Paso 10: Seguimiento inspeccion</th>
                    <th>Paso 11: Acta de cierre</th>
                    <th>Paso 11: Se informa a Inspecci√≥n</th>
                    <th>Paso 11: Se informa a familia</th>
                    <th>Paso 11: Se informa a profesorado</th>
                    <th>Observaciones</th>
                    <th>Fecha de creacion</th>
                    <th>Fecha de modificacion</th>


                    <th class="actions">Acciones</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="alumno : ${alumnos}">

                    <td class="id-col" th:text="${alumno.id}"></td>
                    <td th:text="${alumno.idCaso}"></td>
                    <td th:text="${alumno.idDocumento}"></td>


                    <th:block th:insert="~{listados/pasos/paso1 :: paso1(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso2 :: paso2(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso3 :: paso3(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso4 :: paso4(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso5 :: paso5(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso6 :: paso6(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso7 :: paso7(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso8 :: paso8(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso9 :: paso9(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso10 :: paso10(${alumno})}"/>
                    <th:block th:insert="~{listados/pasos/paso11 :: paso11(${alumno})}"/>

                    <td th:text="${alumno.observaciones}"></td>
                    <td th:text="${#temporals.format(alumno.fechaCreacion,'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${#temporals.format(alumno.fechaUltimaActualizacion,'dd/MM/yyyy HH:mm')}"></td>

                    <td class="actions">
                        <a th:href="@{/alumnado/editar/{id}(id=${alumno.id})}" class="action-edit">‚úèÔ∏è</a>
                        <a th:href="@{/alumnado/eliminar/{id}(id=${alumno.id})}" class="action-delete">üóëÔ∏è</a>
                    </td>

                </tr>
                </tbody>

            </table>
        </div>
    </div>

</div>
<script>
function filtrarPorCodigo() {
const input = document.getElementById('buscarCodigo');
const filtro = input.value.toUpperCase().trim();
const tabla = document.getElementById('tablaCasos');
const filas = tabla.getElementsByClassName('fila-caso');
const noResults = document.getElementById('noResults');
const resultadosCount = document.getElementById('resultadosCount');

let casosVisibles = 0;

for (let i = 0; i < filas.length; i++) {
const fila = filas[i];
// Buscar el c√≥digo en la columna Paso 1 (√≠ndice 3, despu√©s de ID, ID Caso, ID Doc)
const columnaPaso1 = fila.getElementsByTagName('td')[3];

if (columnaPaso1) {
const textoCodigo = columnaPaso1.textContent || columnaPaso1.innerText;

// Extraer el c√≥digo del texto "C√≥digo: XXX"
const codigoMatch = textoCodigo.match(/C√≥digo:\s*(.+?)(?:\s|$)/);
const codigo = codigoMatch ? codigoMatch[1].trim() : '';

if (filtro === '' || codigo.toUpperCase().indexOf(filtro) > -1) {
fila.style.display = '';
casosVisibles++;
} else {
fila.style.display = 'none';
}
}
}

// Mostrar/ocultar mensaje de sin resultados
if (casosVisibles === 0 && filtro !== '') {
noResults.style.display = 'block';
} else {
noResults.style.display = 'none';
}

// Mostrar contador de resultados
if (filtro !== '') {
resultadosCount.textContent = `(${casosVisibles} caso${casosVisibles !== 1 ? 's' : ''} encontrado${casosVisibles !== 1 ? 's' : ''})`;
resultadosCount.style.color = '#666';
resultadosCount.style.fontStyle = 'italic';
} else {
resultadosCount.textContent = '';
}
}

function limpiarFiltro() {
document.getElementById('buscarCodigo').value = '';
filtrarPorCodigo();
}

// Permitir buscar al presionar Enter
document.getElementById('buscarCodigo').addEventListener('keypress', function(event) {
if (event.key === 'Enter') {
event.preventDefault();
filtrarPorCodigo();
}
});
</script>
</body>
</html>
